<style>
  #norwayLists_belaning {
    padding: 16px;
    background: #ffffff;
    color: #544952;
    /*max-height: 864px;*/
    /*overflow: hidden;*/
    /*position: relative;*/
  }
</style>

<script type="text/javascript">
  var infrontUI_bela = null;

  //include InfrontSessionInclude
  $(document).ready(function() {
    var infrontSession_bela = null;

    fetch("/rest-api/Infront%20token/token")
    .then((response) => response.json())
    .then((data) => {
      var token = data.token;
      if (token) {
        let opts = new Infront.InfrontUIOptions();
        opts.language = "sv";
        opts.routingUrl = "https://pareto-mws1.infrontservices.com/mws";
        opts.streaming = true;
        opts.signed_token = token;
        opts.token_type = "JWT";
        opts.client_application = "WEB";
        infrontUI_bela = new Infront.UI(opts);
        infrontUI_bela.registerEventObserver("onReady", infrontReady_bela);
        infrontUI_bela.init();
        infrontSDK = new InfrontSDK.SDK({
          signedToken: token,
          onReady: infrontSDKReady_bela
        });
      }
    });
  });

  //End Include
  var widget_bela;
  var currentFeed_bela;

  function instrumentTradeLink_bela(isin, feed) {
    return (
      "https://online.paretosec.com/trade/trade?isin=" + isin + "&market=" + feed
    );
  }

  function createBaseListOptions_bela(instruments, feed) {
    var cvOpts = new Infront.QuoteListWidgetOptions();
    cvOpts.maxItems = instruments.length;
    cvOpts.columns = [
      {
        name: "TICKER",
        flag: true,
        hover: "FULL_NAME"
      },
      {
        name: "FULL_NAME"

      },

      { name: "LAST_VALID" },
      { name: "CHANGE" },
      { name: "PCT_CHANGE" },
      { name: "TURNOVER" },
      {
        name: "MCAP",
        heading: "MCap",
        shorten: true,
        type: Infront.FieldType.Computed,
        dataType: Infront.DataType.Integer,
        computeFields: ["NUM_SHARES", "LAST_VALID"],
        compute: function(rowId, args) {
          return args[0] * args[1];
        }
      },
      {
        name: "BROKER_COLLATERAL_PCT",
        translate: function(c, v, i) {
          return "<strong>" + InfrontUtil.formatPercent(v, 0) + "</strong>";
        }
      },
      {
        name: "S_DATETIME"
      },

      {
        name: "",
        type: Infront.FieldType.Computed,
        sortable: false,
        className: "cell-text-right",
        computeFields: ["ISIN"],
        compute: (rowId, args) => {
          return args[0];
        },
        translate: function(rowId, isin) {
          var result =
            "<a href='" +
            instrumentTradeLink_bela(isin, rowId.feed) +
            "'><img title='Trade this' alt='H' src='/images/18.2c2f7afa18c8abb97cf4d9c/1703832132295/tradebtn_mini_no.png' class='btnTrade'></a>";
          return result;
        }
      }
    ];

    if ([26, 19, 2008, 2012, 2047, 15, 14].includes(currentFeed_bela) || Array.isArray(currentFeed_bela)) {
      cvOpts.columns = cvOpts.columns.filter(x => !["TURNOVER", "MCAP", "TURNOVER", "LAST_VALID", "CHANGE", "PCT_CHANGE", "S_DATETIME"].includes(x.name));
    }
    cvOpts.instruments = instruments;
    cvOpts.sortable = true;
    cvOpts.enableChangeStatusColors = true;
    cvOpts.defaultSortedColumn = "TICKER";
    cvOpts.defaultSortOrder = 0;
    cvOpts.useChains = false;
    cvOpts.interactionHighlight = true;
    return cvOpts;
  }

  function infrontReady_bela(event) {

  }

  var instruments_bela = [];
  var timeout_bela;

  function changeFeed_bela(feed) {
    if (currentFeed_bela == feed) {
      return;
    }
    currentFeed_bela = feed;
    if (widget_bela) {
      widget_bela.destroy();
    }
    $("#loader").show();
    clearTimeout(timeout_bela);
    instruments_bela = [];
    if (Array.isArray(feed)) {
      feed.reduce((seq, f) => {
        return seq.then(() => loadFeed_bela(f));
      }, Promise.resolve());
    } else {
      loadFeed_bela(feed);
    }

  }

  function loadFeed_bela(feed) {
    return new Promise((res, rej) => {
      res();
      infrontSDK.get(
        InfrontSDK.feedContents({
          contentType: InfrontSDK.FeedContentType.SymbolIds,
          feed: feed,
          subscribe: false,
          limit: -1,
          fields: ["Ticker", "ISIN"],
          onData: function(results) {

            results.map((id) => {
              return infrontSDK.get(
                InfrontSDK.symbolData({
                  subscribe: false,
                  content: {
                    AdditionalData: true,
                    Basic: true
                  },
                  fields: ["Ticker", "CollateralPct"],
                  id,

                  onData: function(item) {

                    if ((Array.isArray(currentFeed_bela) && currentFeed_bela.includes(feed)) || currentFeed_bela === feed) {
                      if (item.get("CollateralPct") !== null) {
                        update_bela({
                          feed: item.get("Feed"),
                          ticker: item.get("Ticker")
                        });

                      } else {
                        update_bela();
                      }
                    }

                  },
                  onStatus: function(requestName, status) {
                    console.log(requestName, " : ", status);
                  }
                })
              );
            });

          }
        })
      );
    });

  }


  function update_bela(instrument) {
    if (instrument) {
      instruments_bela.push(instrument);
    }
    clearTimeout(timeout_bela);
    timeout_bela = setTimeout(initWidget_bela, 500);


  }

  function initWidget_bela() {
    $("#loader").hide();
    if (widget_bela) {
      widget_bela.destroy();
    }
    var opts = createBaseListOptions_bela(instruments_bela);
    widget_bela = infrontUI_bela.quoteList("norwayLists_belaning", opts);
  }

  function infrontSDKReady_bela(event) {
    changeFeed_bela(17921);
  }

  function toggleActiveTab(element) {
    const tabs = document.querySelectorAll("#norwayLists_belaning_tabs a");
    tabs.forEach((tab) => {
      tab.classList.remove("activeTab");
    });
    element.classList.add("activeTab");
  }
</script>

<ul id="norwayLists_belaning_tabs" class="companyTabs customTabs" style="border-top:0;border-left:0;border-right:0">
  <li><a class="activeTab" onclick="changeFeed_bela(17921);toggleActiveTab(this);">Sverige</a></li>
  <li><a onclick="changeFeed_bela(18177);toggleActiveTab(this);">Norge</a></li>
  <li><a onclick="changeFeed_bela(17665);toggleActiveTab(this);">Danmark</a></li>
  <li><a onclick="changeFeed_bela(100);toggleActiveTab(this);">Finland</a></li>
  <li><a onclick="changeFeed_bela(26);toggleActiveTab(this);">Tyskland</a></li>
  <li><a onclick="changeFeed_bela(19);toggleActiveTab(this);">UK</a></li>
  <li><a onclick="changeFeed_bela(2008);toggleActiveTab(this);">Frankrike</a></li>
  <li><a onclick="changeFeed_bela(2012);toggleActiveTab(this);">Spania</a></li>
  <li><a onclick="changeFeed_bela(2047);toggleActiveTab(this);">Italia</a></li>
  <li><a onclick="changeFeed_bela(14);toggleActiveTab(this);">USA - NYSE</a></li>
  <li><a onclick="changeFeed_bela(15);toggleActiveTab(this);">USA - NASDAQ</a></li>
</ul>

<div id="loader" style="display:flex;justify-content:center;">
  <i class="fa fa-spinner fa-spin" style="font-size:24px"></i>
</div>
<div id="norwayLists_belaning" class="col-md-12"></div>
